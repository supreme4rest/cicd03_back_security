name: CI/CD Pipeline  # GitHub Actions ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‘ì—… ì‹¤í–‰

    steps:
      - name: Checkout source
        uses: actions/checkout@v3  # GitHub ì €ì¥ì†Œì˜ ì†ŒìŠ¤ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì•¡ì…˜

      - name: Set up JDK 17
        uses: actions/setup-java@v3  # JDK ì„¤ì • ì•¡ì…˜
        with:
          java-version: '17'  # Java 17 ë²„ì „ ì‚¬ìš©
          distribution: 'temurin'  # AdoptOpenJDKì˜ Temurin ë°°í¬íŒ ì‚¬ìš©

      - name: mvnw ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./mvnw  # mvnw íŒŒì¼(Wrapper)ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬

      - name: Maven ë¹Œë“œ ì‹¤í–‰
        run: ./mvnw clean package -DskipTests  # Maven ë¹Œë“œ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ ìƒëµ)
      # run: ./mvnw clean verify  # í…ŒìŠ¤íŠ¸ í¬í•¨ ë¹Œë“œ ì‹œ ì´ ëª…ë ¹ì–´ ì‚¬ìš©

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3  # Docker Hubì— ë¡œê·¸ì¸í•˜ëŠ” ì•¡ì…˜
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # GitHubì— ì €ì¥ëœ ì‹œí¬ë¦¿ ê°’ ì‚¬ìš©
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/jwt-app:latest .  # ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë„ì»¤ ì´ë¯¸ì§€ë¡œ ë¹Œë“œ

      - name: Docker ì´ë¯¸ì§€ í‘¸ì‹œ
        run: docker push ${{ secrets.DOCKER_USERNAME }}/jwt-app:latest  # ë¹Œë“œí•œ ì´ë¯¸ì§€ë¥¼ Docker Hubì— ì—…ë¡œë“œ

      # .env íŒŒì¼ì„ Actions ë‚´ì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±
      - name: .env íŒŒì¼ ìƒì„±
        run: |
          echo "SPRING_JWT_SECRET=${{ secrets.SPRING_JWT_SECRET }}" >> .env  # Spring JWT ì‹œí¬ë¦¿ í‚¤
          echo "MYSQL_URL=${{ secrets.MYSQL_URL }}" >> .env  # DB URL
          echo "MYSQL_USER=${{ secrets.MYSQL_USER }}" >> .env  # DB ì‚¬ìš©ìëª…
          echo "MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}" >> .env  # DB ë¹„ë°€ë²ˆí˜¸
          echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> .env  # ë„ì»¤ í—ˆë¸Œ ì‚¬ìš©ìëª…

      - name: EC2ì— docker-compose.yml + .env ì „ì†¡
        uses: appleboy/scp-action@v0.1.7  # EC2ë¡œ íŒŒì¼ ì „ì†¡í•˜ëŠ” ì•¡ì…˜(SCP ë°©ì‹)
        with:
          host: ${{ secrets.EC2_HOST }}  # EC2 í˜¸ìŠ¤íŠ¸ ì£¼ì†Œ
          username: ${{ secrets.EC2_USERNAME }}  # EC2 ì‚¬ìš©ìëª… (ë³´í†µ ubuntu)
          key: ${{ secrets.EC2_PRIVATE_KEY }}  # EC2 ê°œì¸ í‚¤ (.pem ë‚´ìš©)
          source: "docker-compose.yml,.env"  # ì „ì†¡í•  íŒŒì¼ ëª©ë¡ (ì‰¼í‘œë¡œ êµ¬ë¶„)
          target: "~/cicd-docker"  # EC2 ë‚´ ëŒ€ìƒ ê²½ë¡œ

      - name: EC2ì—ì„œ docker-compose ì‹¤í–‰
        uses: appleboy/ssh-action@v1.0.0  # EC2ì— SSH ì ‘ì†í•˜ì—¬ ëª…ë ¹ ì‹¤í–‰
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            cd ~/cicd-docker  # ë„ì»¤ íŒŒì¼ì´ ìœ„ì¹˜í•œ ê²½ë¡œë¡œ ì´ë™
            docker pull ${{ secrets.DOCKER_USERNAME }}/jwt-app:latest  # ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            docker compose down  # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
            docker compose up -d  # ë°±ê·¸ë¼ìš´ë“œë¡œ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰

      # Slack ì•Œë¦¼ - ì„±ê³µ ì‹œ
      - name: Notify to Slack on Success
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_USERNAME: GitHub Actions
          SLACK_ICON_EMOJI: ':rocket:'
          SLACK_TITLE: 'âœ… ë°°í¬ ì„±ê³µ'
          SLACK_MESSAGE: 'Main ë¸Œëœì¹˜ì— pushë¨ â†’ EC2ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤-ì¶”ì¹´ì¶”ì¹´! ğŸ‰'
          SLACK_COLOR: good

      # Slack ì•Œë¦¼ - ì‹¤íŒ¨ ì‹œ
      - name: Notify to Slack on Failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}  # Slackì—ì„œ ìƒì„±í•œ Webhook URL (GitHub Secretsë¡œ ê´€ë¦¬)
          SLACK_USERNAME: GitHub Actions                   # Slackì— í‘œì‹œë  ë°œì‹ ì ì´ë¦„
          SLACK_ICON_EMOJI: ':x:'                          # Slack ë©”ì‹œì§€ ì•ì— í‘œì‹œë  ì•„ì´ì½˜ (ì‹¤íŒ¨ìš© ì´ëª¨ì§€)
          SLACK_TITLE: 'âŒ ë°°í¬ ì‹¤íŒ¨'                        # Slack ë©”ì‹œì§€ì˜ ì œëª© (êµµì€ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œë¨)
          SLACK_MESSAGE: 'Main ë¸Œëœì¹˜ì— pushë¨ â†’ EC2 ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ğŸ”¥ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'  # Slack ë©”ì‹œì§€ì˜ ë³¸ë¬¸ ë‚´ìš© (ìƒì„¸ ë©”ì‹œì§€)
          SLACK_COLOR: danger                              # ë©”ì‹œì§€ ë°” ìƒ‰ìƒ (green=good, red=danger, yellow=warning)

